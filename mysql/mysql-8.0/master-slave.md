# Master / Slave 이중화

{% embed url="https://jane096.github.io/project/mysql-master-slave-replication/" %}

MySQL에서 마스터(Master)와 슬레이브(Slave) 구성은 데이터베이스 복제(Replication)를 위해 사용되는 아키텍처입니다. 이 구조는 데이터의 일관성과 가용성을 높이고, 읽기 쿼리의 부하 분산, 백업 용이성, 재해 복구 준비 등 다양한 목적으로 활용됩니다.

#### 데이터베이스 복제(Replication)의 개념

* **목적:** 데이터베이스 복제는 하나의 데이터베이스 서버(마스터)의 데이터 변경 사항(INSERT, UPDATE, DELETE 등)을 실시간으로 하나 이상의 데이터베이스 서버(슬레이브)에 복사하는 과정입니다. 이를 통해 데이터를 동기화하며, 여러 읽기 전용 복제본을 유지할 수 있습니다.
* **작동 방식:** 마스터 서버에서 발생하는 모든 데이터 변경 사항은 바이너리 로그(Binary Log)에 기록됩니다. 슬레이브 서버는 이 바이너리 로그를 주기적으로 가져와(replay) 자신의 데이터를 업데이트함으로써 마스터와 동일한 데이터 상태를 유지합니다.

#### 마스터(Master)의 역할

* **데이터 변경 관리:** 모든 데이터 변경(쓰기 작업)은 마스터 서버에서 수행됩니다. 마스터는 이러한 변경 사항을 바이너리 로그에 기록합니다.
* **복제 로그 관리:** 마스터 서버는 바이너리 로그를 관리하며, 슬레이브 서버들이 이를 가져갈 수 있도록 합니다.

#### 슬레이브(Slave)의 역할

* **데이터 동기화:** 슬레이브 서버는 마스터의 바이너리 로그를 주기적으로 가져와서 자신의 데이터를 업데이트합니다. 이 과정을 통해 마스터와 동일한 데이터 상태를 유지합니다.
* **읽기 쿼리 처리:** 슬레이브 서버는 주로 읽기 쿼리(조회 작업)를 처리하는 데 사용됩니다. 이를 통해 마스터 서버의 부하를 줄이고, 전체 시스템의 읽기 성능을 향상시킬 수 있습니다.
* **백업:** 슬레이브 서버는 시스템의 중단 없이 백업을 수행할 수 있는 대상으로도 사용됩니다.

#### 복제 구성의 장점

* **고가용성:** 슬레이브 서버를 통해 데이터의 여러 복제본을 유지함으로써, 마스터 서버에 문제가 발생해도 데이터의 가용성을 보장할 수 있습니다.
* **부하 분산:** 읽기 쿼리를 슬레이브 서버로 분산시켜 마스터 서버의 부하를 경감시키고, 시스템의 전반적인 성능을 향상시킬 수 있습니다.
* **재해 복구:** 데이터의 여러 복제본을 지리적으로 분산된 위치에 둠으로써, 재해 발생 시 데이터를 신속하게 복구할 수 있습니다.

MySQL에서 복제를 구성할 때는 마스터와 슬레이브 간의 데이터 동기화 지연, 네트워크 연결 안정성, 슬레이브 서버의 데이터 일관성 확인 등 여러 요소를 고려해야 합니다.



## 비용처리

아무래도 단일 인스턴스로 사용하는것보다 비용이 더 많이 발생하게 된다.



#### 단일 MySQL 인스턴스 사용 시

* **하드웨어/인스턴스 비용:** 하나의 서버 또는 인스턴스에 대한 비용만 발생합니다.
* **스토리지 비용:** 사용하는 데이터 양에 따라 스토리지 비용이 발생합니다.
* **운영 및 관리 비용:** 단일 시스템을 모니터링하고 관리하는 데 드는 비용.

#### 마스터/슬레이브 구성 사용 시

* **하드웨어/인스턴스 비용:** 최소한 한 대의 슬레이브를 추가해야 하므로, 단일 인스턴스보다 더 많은 서버 또는 인스턴스에 대한 비용이 발생합니다. 슬레이브의 수가 많아질수록 비용은 증가합니다.
* **스토리지 비용:** 마스터 서버와 동일한 데이터를 유지하기 위해 슬레이브 서버마다 추가 스토리지 공간이 필요합니다. 이로 인해 전체적인 스토리지 비용이 증가합니다.
* **네트워크 비용:** 클라우드 환경에서는 데이터 복제로 인한 데이터 전송 비용이 발생할 수 있습니다.
* **운영 및 관리 비용:** 복제 구성을 모니터링하고 유지 관리하는 데 드는 비용이 증가합니다. 복제 설정, 복제 지연 모니터링, 데이터 무결성 검증 등 추가적인 관리 작업이 필요합니다.



* 마스터/슬레이브 구성은 고가용성, 부하 분산, 데이터 백업 및 복구 등의 이점을 제공하지만, 단일 인스턴스 사용에 비해 상대적으로 비용이 더 많이 들 수 있습니다. 추가적인 서버/인스턴스, 스토리지, 관리 작업 등이 비용 증가의 주된 요인입니다.
* 비용 증가는 높은 가용성과 성능 향상의 필요성에 따라 정당화될 수 있습니다. 기업이나 조직의 요구 사항에 따라 이러한 추가 비용이 비즈니스 가치를 창출할 수 있습니다.

실제 비용 차이는 사용하는 클라우드 서비스 제공 업체의 가격 정책, 서버/인스턴스의 사양, 스토리지 용량, 네트워크 사용량 등에 따라 달라질 수 있으므로, 정확한 비용 분석을 위해서는 해당 서비스의 가격 계산기를 사용하거나 견적을 요청하는 것이 좋습니다.



## 구성 방법



MySQL에서 마스터-슬레이브 복제를 구성하고 운영하기 위해 고려해야 할 주요 단계와 팁은 다음과 같습니다. 이 과정은 복제를 설정하고, 복제의 안정성을 확보하며, 데이터 일관성을 유지하는 데 필요한 지침을 제공합니다.

#### 1. 복제를 위한 마스터 서버 설정

*   **바이너리 로깅 활성화:** 마스터 서버에서 `my.cnf` (또는 `my.ini` on Windows) 파일을 수정하여 바이너리 로깅을 활성화합니다. `log_bin` 옵션을 사용합니다.

    ```
    [mysqld]
    log_bin=mysql-bin
    server_id=1
    ```
* **유니크한 서버 ID 할당:** 마스터와 각 슬레이브 서버에 고유한 `server_id` 값을 설정합니다. 이 값은 전역적으로 고유해야 합니다.

#### 2. 슬레이브 서버 설정

*   **서버 ID 설정:** 마찬가지로 슬레이브 서버의 `my.cnf` 파일에 유니크한 `server_id`를 설정합니다.

    ```
    [mysqld]
    server_id=2
    ```
*   **복제를 위한 사용자 생성:** 마스터 서버에서 복제를 위한 전용 MySQL 사용자를 생성하고, 필요한 권한을 부여합니다.

    ```sql
    CREATE USER 'replica'@'%' IDENTIFIED BY 'password';
    GRANT REPLICATION SLAVE ON *.* TO 'replica'@'%';
    ```

#### 3. 초기 데이터 복사

* **데이터 스냅샷 생성:** 마스터 데이터베이스의 일관된 스냅샷을 생성합니다. 이는 슬레이브 서버의 초기 데이터 세트로 사용됩니다. `mysqldump` 또는 MySQL Enterprise Backup 같은 도구를 사용할 수 있습니다.
* **스냅샷을 슬레이브에 적용:** 생성된 백업으로부터 슬레이브 데이터베이스를 복원합니다.

#### 4. 복제 시작

*   **마스터 서버 정보 설정:** 슬레이브 서버에서 마스터 서버의 바이너리 로그 위치와 복제 사용자 정보를 설정하고 복제를 시작합니다.

    ```sql
    CHANGE MASTER TO
    MASTER_HOST='master_ip',
    MASTER_USER='replica',
    MASTER_PASSWORD='password',
    MASTER_LOG_FILE='mysql-bin.000001',  -- 마스터에서 확인한 로그 파일 이름
    MASTER_LOG_POS=123;  -- 로그 파일의 위치
    START SLAVE;
    ```
* **복제 상태 확인:** `SHOW SLAVE STATUS\G;` 쿼리를 실행하여 복제 상태를 확인합니다. `Slave_IO_Running`과 `Slave_SQL_Running` 값이 모두 `Yes`인지 확인합니다.

#### 5. 운영 및 모니터링

* **복제 지연 모니터링:** 네트워크 지연, 하드웨어 성능, 대량의 데이터 변경 등으로 인해 복제 지연이 발생할 수 있습니다. 정기적으로 `Seconds_Behind_Master` 값을 확인하여 복제 지연을 모니터링합니다.
* **복제 무결성 검증:** 데이터 무결성을 보장하기 위해 주기적으로 마스터와 슬레이브 간의 데이터를 비교 및 검증합니다.

복제 설정 과정에서는 정확한 구성과 초기 스냅샷의 일관성, 네트워크 설정 등 여러 요소가 중요합니다. 또한, 복제 동작 중 발생할 수 있는 예외 상황에 대비하여 적절한 모니터링과 관리 정책을 수립하는 것이 중요합니다.

